<?php
defined('WYSIJA') or die('Restricted access'); class WYSIJA_model_list extends WYSIJA_model{ var $pk="list_id"; var $table_name="list"; var $columns=array( 'list_id'=>array("auto"=>true), 'name' => array("req"=>true,"type"=>"text"), 'description' => array("type"=>"text"), 'unsub_mail_id' => array("req"=>true,"type"=>"integer"), 'welcome_mail_id' => array("req"=>true,"type"=>"integer"), 'is_enabled' => array("req"=>true,"type"=>"boolean"), 'ordering' => array("req"=>true,"type"=>"integer"), 'created_at' => array("req"=>true,"type"=>"integer"), ); var $escapeFields=array('name','description'); var $escapingOn=true; function WYSIJA_model_list(){ $this->columns['name']['label']=__('Name',WYSIJA); $this->columns['description']['label']=__('Description',WYSIJA); $this->columns['is_enabled']['label']=__('Enabled',WYSIJA); $this->columns['ordering']['label']=__('Ordering',WYSIJA); $this->WYSIJA_model(); } function getLists($id=false){ if($id){ $query="SELECT A.name, A.list_id, A.description, A.is_enabled
                FROM ".$this->getPrefix()."list as A
                LEFT JOIN ".$this->getPrefix()."email as B on A.welcome_mail_id=B.email_id 
                WHERE A.list_id=".(int)$id; $result=$this->getResults($query); $this->escapeQuotesFromRes($result); return $result[0]; }else{ $query="SELECT A.name, A.list_id, A.created_at, A.is_enabled, 0 as subscribers, 0 as campaigns_sent
            FROM ".$this->getPrefix()."list as A"; $this->countRows=$this->count($query); $query.=$this->setLimit(); $listres=$this->getResults($query); $listids=array(); foreach($listres as $res) $listids[]=$res['list_id']; $qry="SELECT count(distinct A.user_id) as nbsub,A.list_id FROM `".$this->getPrefix()."user_list` as A WHERE list_id IN (".implode(',',$listids).") GROUP BY list_id"; $qry1="SELECT count(distinct A.user_id) as nbsub,A.list_id FROM `".$this->getPrefix()."user_list` as A LEFT JOIN `".$this->getPrefix()."user` as B on A.user_id=B.user_id WHERE list_id IN (".implode(',',$listids).") AND B.status >0 GROUP BY list_id"; $qry15="SELECT count(distinct A.user_id) as nbsub,A.list_id FROM `".$this->getPrefix()."user_list` as A LEFT JOIN `".$this->getPrefix()."user` as B on A.user_id=B.user_id WHERE list_id IN (".implode(',',$listids).") AND B.status =0 GROUP BY list_id"; $qry2="SELECT count(distinct A.user_id) as nbunsub,A.list_id FROM `".$this->getPrefix()."user_list` as A LEFT JOIN `".$this->getPrefix()."user` as B on A.user_id=B.user_id WHERE list_id IN (".implode(',',$listids).") AND B.status <0 GROUP BY list_id"; $total=$this->getResults($qry); $subscribed=$this->getResults($qry1); $unconfirmed=$this->getResults($qry15); $unsubscribed=$this->getResults($qry2); foreach($total as $tot){ foreach($listres as $key=>$res){ if($tot['list_id']==$res['list_id']) $listres[$key]['totals']=$tot['nbsub']; } } foreach($subscribed as $subscriber){ foreach($listres as $key=>$res){ if($subscriber['list_id']==$res['list_id']) $listres[$key]['subscribers']=$subscriber['nbsub']; } } foreach($unconfirmed as $subscriber){ foreach($listres as $key=>$res){ if($subscriber['list_id']==$res['list_id']) $listres[$key]['unconfirmed']=$subscriber['nbsub']; else $listres[$key]['unconfirmed']=0; } } foreach($unsubscribed as $unsubsubscriber){ foreach($listres as $key=>$res){ if($unsubsubscriber['list_id']==$res['list_id']) $listres[$key]['unsubscribers']=$unsubsubscriber['nbunsub']; } } foreach($listres as $key=>$res){ if(!isset($listres[$key]['unconfirmed'])) $listres[$key]['unconfirmed']=0; if(!isset($listres[$key]['unsubscribers'])) $listres[$key]['unsubscribers']=0; if(!isset($listres[$key]['subscribers'])) $listres[$key]['subscribers']=0; if(!isset($listres[$key]['totals'])) $listres[$key]['totals']=0; } $this->escapeQuotesFromRes($listres); return $listres; } } } 