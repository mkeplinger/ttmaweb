Event.cacheDelegated={};Object.extend(document,(function(){var c=Event.cacheDelegated;function d(g){return c[g]=c[g]||{}}function e(g,h){var i=d(g);return i[h]=i[h]||[]}function b(g,h,i){var j=e(g,h);return j.find(function(k){return k.handler==i})}function f(g,h,i){var k=d(g);if(!k[h]){return false}var j=b(g,h,i);k[h]=k[h].without(j);return j}function a(g,h,j,i){var l,k=e(g,h);if(k.pluck("handler").include(j)){return false}l=function(n){var m=n.findElement(g);if(m){j.call(i||m,n,m)}};l.handler=j;k.push(l);return l}return{delegate:function(g,h,j,i){var k=a.apply(null,arguments);if(k){document.observe(h,k)}return document},stopDelegating:function(g,h,i){var j=arguments.length;switch(j){case 2:e(g,h).each(function(l){document.stopDelegating(g,h,l.handler)});break;case 1:Object.keys(d(g)).each(function(l){document.stopDelegating(g,l)});break;case 0:Object.keys(c).each(function(l){document.stopDelegating(l)});break;default:var k=f.apply(null,arguments);if(k){document.stopObserving(h,k)}}return document}}})());var Observable=(function(){function d(e,f){e=e.substring(2);if(f){e=f+":"+e}return e.underscore().split("_").join(":")}function b(e){var g=e.prototype,f=g.namespace;return Object.keys(g).grep(/^on/).inject($H(),function(h,i){if(i=="onDomLoaded"){return h}h.set(d(i,f),a(g[i],e));return h})}function a(f,e){return function(g){return f.call(new e(this),g,g.memo)}}function c(f,e){$$(f).each(function(g){new e(g).onDomLoaded()})}return{observe:function(f){if(!this.handlers){this.handlers={}}if(this.handlers[f]){return}var e=this;if(this.prototype.onDomLoaded){document.loaded?c(f,e):document.observe("dom:loaded",c.curry(f,e))}this.handlers[f]=b(e).each(function(g){document.delegate(f,g.key,g.value)})},stopObserving:function(e){if(!this.handlers||!this.handlers[e]){return}this.handlers[e].each(function(f){document.stopDelegating(e,f.key,f.value)});delete this.handlers[e]}}})();Object.extend(Droppables,{deactivate:Droppables.deactivate.wrap(function(c,b,a){if(b.onLeave){b.onLeave(a,b.element)}return c(b)}),activate:Droppables.activate.wrap(function(c,b,a){if(b.onEnter){b.onEnter(a,b.element)}return c(b)}),show:function(a,c){if(!this.drops.length){return}var b,d=[];this.drops.each(function(e){if(Droppables.isAffected(a,c,e)){d.push(e)}});if(d.length>0){b=Droppables.findDeepestChild(d)}if(this.last_active&&this.last_active!=b){this.deactivate(this.last_active,c)}if(b){Position.within(b.element,a[0],a[1]);if(b.onHover){b.onHover(c,b.element,Position.overlap(b.overlap,b.element))}if(b!=this.last_active){Droppables.activate(b,c)}}},displayArea:function(a){if(!this.drops.length){return}var b;this.drops.each(function(c){if(c.element.hasClassName("block_placeholder")){b=a.element.getHeight();c.element.resizeHeight(((b>30)?30:b));c.element.addClassName("active")}else{if(c.element.hasClassName("image_placeholder")){if(a.element.hasClassName("wysija_item_image")){c.element.addClassName("active")}}else{if(c.element.hasClassName("text_placeholder")){if(a.element.hasClassName("wysija_item_text")){try{var f=c.element.up(".wysija_content").readAttribute("wysija_align")||Wysija.defaults.contentAlignment;if(f=="center"){c.element.resizeHeight(30)}else{b=c.element.up(".wysija_content").down(".wysija_image img").getHeight();if(c.element.getHeight()<b){c.element.resizeHeight(b-2)}}}catch(d){}c.element.addClassName("active")}}}}})},hideArea:function(){if(!this.drops.length){return}var a;this.drops.each(function(b){if(b.element.hasClassName("block_placeholder")){b.element.resizeHeight(0);b.element.removeClassName("active")}else{if(b.element.hasClassName("image_placeholder")){b.element.removeClassName("active")}else{if(b.element.hasClassName("text_placeholder")){b.element.removeClassName("active")}}}})},reset:function(a){if(this.last_active){this.deactivate(this.last_active,a)}}});Element.addMethods({resizeHeight:function(c,a,b,d){return new Effect.Morph(c,{style:{height:parseInt(a)+"px"},afterUpdate:b,afterFinish:d,duration:0.2})},scrollToCenter:function(b,a){var b=$(b);var c=Object.extend({duration:0.2,offset:-document.viewport.getHeight()/2},a||{});Effect.ScrollTo(b,c);return b}});var Wysija={version:"1.0.0",options:{debug:false,toolbar:"wysija_toolbar",wrapper:"wysija_wrapper",container:"wysija_container",header:"wysija_header",body:"wysija_body",footer:"wysija_footer"},dragging:false,defaults:{contentAlignment:"left"},doSave:false,autoSave:function(){if(Wysija.doSave==false){Wysija.doSave=true}return},save:function(){var e,b,d={},c=$H();c.set("version",Wysija.version);var f=Wysija.getHeader();d=f.block.save();d.type="header";c.set("header",d);var a=$H();Wysija.getBlocks().each(function(g){e=g.block;if(e.save){b=e.element.readAttribute("wysija_position");d=e.save();d.position=b;d.type=g.elementType;a.set("block-"+b,d)}});c.set("body",a);return Object.toJSON(c)},blockDropOptions:{accept:$w("wysija_item_image wysija_item_text wysija_item_divider wysija_item_post"),onEnter:function(a,b){$(b).addClassName("hover")},onLeave:function(a,b){$(b).removeClassName("hover")},onDrop:function(a,c){var b={};b.elementType=a.readAttribute("wysija_type");b.element=a;if(b.elementType=="image"){b.elementRatio=a.readAttribute("elementRatio");b.elementSrc=a.readAttribute("wysija_src");b.elementWidth=a.readAttribute("wysija_width");b.elementHeight=a.readAttribute("wysija_height")}else{if(b.elementType=="divider"){b.elementSrc=a.readAttribute("wysija_src");b.elementWidth=a.readAttribute("wysija_width");b.elementHeight=a.readAttribute("wysija_height")}else{if(b.elementType=="text"){b.elementText=Wysija_i18n.clickToEditText}}}c.fire("item:dropped",b);$(c).removeClassName("hover")}},imageDropOptions:{accept:$w("wysija_item_image"),onEnter:function(a,b){$(b).addClassName("hover")},onLeave:function(a,b){$(b).removeClassName("hover")},onDrop:function(a,c){var b={};b.elementType=a.readAttribute("wysija_type");b.element=a;b.elementRatio=a.readAttribute("elementRatio");b.elementSrc=a.readAttribute("wysija_src");b.elementWidth=a.readAttribute("wysija_width");b.elementHeight=a.readAttribute("wysija_height");c.fire("image:dropped",b);$(c).removeClassName("hover")}},textDropOptions:{accept:$w("wysija_item_text"),onEnter:function(a,b){$(b).addClassName("hover")},onLeave:function(a,b){$(b).removeClassName("hover")},onDrop:function(a,c){var b={};b.elementType=a.readAttribute("wysija_type");b.element=a;b.elementText=Wysija_i18n.clickToEditText;c.fire("text:dropped",b);$(c).removeClassName("hover")}},instances:{},get:function(b,c){if(c==undefined){c="block"}var d=b.identify();var a=Wysija.instances[d]||new Wysija[c.capitalize()](d);Wysija.instances[d]=a;return a},getHeader:function(){return Wysija.get(Wysija.getHeaderElement(),"header")},getHeaderElement:function(){return $$("div.wysija_header")[0]},getBlocks:function(){return Wysija.getBlockElements().map(function(a){return Wysija.get(a)})},getBlockElements:function(){return $$("div.wysija_block")},setBlockPositions:function(){Wysija.dragging=false;var a=1;Wysija.getBlocks().each(function(b){b.setPosition(a++)});Wysija.autoSave()},startBlockPositions:function(){Wysija.dragging=true;Wysija.hideEditors()},init:function(){Wysija.getHeader();Wysija.makeDroppable();Wysija.makeSortable();Wysija.setBlockPositions();Wysija.hideControls();Wysija.hideTools();$(Wysija.options.toolbar).setStyle({top:$(Wysija.options.wrapper).positionedOffset().top+"px"})},hideBlockControls:function(){$$(".wysija_controls").invoke("hide");this.getBlockElements().invoke("removeClassName","hover")},hideEditors:function(){$$(".wysija_text").invoke("setStyle",{width:"auto","float":"none"});if(tinymce.editors.length>0){if(Wysija.getHeader().block.contents!=null){Wysija.getHeader().block.contents.disableEditor()}Wysija.getBlocks().each(function(a){if(a.elementType=="content"&&a.block.contents!=null){a.block.contents.disableEditor()}})}},constrainSize:function(){Wysija.getBlocks().each(function(a){if(a.elementType=="content"){if(a.block.contents!=null){a.block.contents.constrainSize()}}})},hideControls:function(){return Wysija.getBlocks().invoke("hideControls")},hideTools:function(){$$(".resize-controls").invoke("hide");$$(".wysija_tools").invoke("hide")},makeDroppable:function(){Droppables.add("block_placeholder",Wysija.blockDropOptions)},makeSortable:function(){var a=$(Wysija.options.body);Sortable.create(a,{tag:"div",only:"wysija_block",scroll:window,handle:"handle",constraint:"vertical"});Draggables.removeObserver(a);Draggables.addObserver({element:a,onStart:Wysija.startBlockPositions,onEnd:Wysija.setBlockPositions})}};document.observe("dom:loaded",Wysija.init);Wysija.Block=Class.create({initialize:function(a){info("block -> init");this.element=$(a);this.elementType=this.element.readAttribute("wysija_type");this.block=new Wysija[this.elementType.capitalize()](this.element);if(parseInt(this.element.readAttribute("wysija_new"))==1){this.block.draw();this.element.writeAttribute("wysija_new",0)}this.block.makeBlockDroppable();this.block.setup();return this},getCustomData:function(a){try{info("got options for "+a);return this.element.down(".wysija_options."+a).innerHTML.toQueryParams("&amp;")}catch(b){info("[ERROR] -> no options to get for "+a);return null}},getOptions:function(){return this.options},setOptions:function(a){if(a==undefined){a={}}if(this.options==undefined){this.options=new Hash()}this.options=this.options.update(a);return this},setPosition:function(a){this.element.writeAttribute("wysija_position",a)},hideControls:function(){if(this["getControls"]){this.getControls().hide()}},showControls:function(){if(this["getControls"]){this.getControls().show()}},makeBlockDroppable:function(){if(this.isBlockDroppableEnabled()==false){Droppables.add(this.getBlockDroppable().identify(),Wysija.blockDropOptions);this.getBlockDroppable().addClassName("enabled")}},removeBlockDroppable:function(){if(this.isBlockDroppableEnabled()){Droppables.remove(this.getBlockDroppable().identify());this.getBlockDroppable().removeClassName("enabled")}},isBlockDroppableEnabled:function(){if(this.element.hasClassName("static")){return true}if(this.getBlockDroppable()==undefined){this.createBlockDroppable()}return this.getBlockDroppable().hasClassName("enabled")},createBlockDroppable:function(){info("block -> createBlockDroppable");this.element.insert({top:'<div class="block_placeholder"></div>'})},getBlockDroppable:function(){return this.element.down(".block_placeholder")},duplicateBlock:function(){},removeBlock:function(){Wysija.instances[this.element.identify()]=null;this.element.blindUp({duration:0.2,afterFinish:function(a){a.element.remove();Wysija.setBlockPositions()}})},setFocus:function(){this.element.scrollToCenter()}});document.observe("item:dropped",function(a){Wysija.Block.create(a.memo,a.target)});Wysija.Block.create=function(c,e){var b='<li><a class="handle" href="javascript:;"><span></span></a></li>';if(c.elementType=="image"){c.elementOptions='<span class="wysija_options image">#{options}</span>'.interpolate({options:Object.toQueryString(c)});c.elementType="content";c.blockAlignment=Wysija.defaults.contentAlignment}if(c.elementType=="text"){c.elementOptions='<span class="wysija_options text">#{options}</span>'.interpolate({options:Object.toQueryString(c)});c.elementType="content";c.blockAlignment=Wysija.defaults.contentAlignment}if(c.elementType=="divider"){c.elementOptions='<span class="wysija_options divider">#{options}</span>'.interpolate({options:Object.toQueryString(c)});b+='<li><a class="remove" href="javascript:;"><span></span></a></li>'}var f,a=$(Wysija.options.body),d=new Template('<div class="wysija_block" wysija_type="#{elementType}" wysija_new="1"><ul class="wysija_controls">'+b+'</ul>#{elementOptions}<div class="wysija_#{elementType} #{blockAlignment}"></div></div>');if(e.identify()=="block_placeholder"){a.insert(d.evaluate(c));f=a.childElements().last()}else{e.up(".wysija_block").insert({before:d.evaluate(c)});f=e.up(".wysija_block").previous(".wysija_block")}Wysija.makeSortable();Wysija.setBlockPositions();content=Wysija.get(f);content.block.setFocus();if(content.block.contents!=undefined&&content.block.contents.isEmpty()==false){content.block.contents.setFocus()}};Wysija.Header=Class.create({initialize:function(a){this.element=$(a);this.block=new Wysija.FullContent(this.element);this.block.setup();return this}});Wysija.Content=Class.create(Wysija.Block,{contents:null,image:null,constraints:{left:{minWidth:32,maxWidth:325},right:{minWidth:32,maxWidth:325},center:{minWidth:32,maxWidth:578},full:{maxWidth:578}},initialize:function(a,b){this.element=$(a);if(this.getTextContainer()){this.contents=new Wysija.Text(this.getTextContainer())}if(this.getImageContainer()){this.image=new Wysija.Image(this.getImageContainer())}return this},save:function(){var a={};if(this.contents!=null){a.text=this.contents.save()}if(this.image!=null){a.image=this.image.save();if(this.image.isEmpty()==false){a.alignment=a.image["alignment"]}else{a.alignment="center"}a["static"]=(this.element.hasClassName("static"))}return a},draw:function(){if(this.image==null){this.element.childElements().last().insert(this.drawContainer("image"));this.image=new Wysija.Image(this.getImageContainer());this.image.setOptions(this.getCustomData("image"));this.getImageContainer().insert(this.image.draw())}if(this.contents==null){this.element.childElements().last().insert(this.drawContainer("text"));this.contents=new Wysija.Text(this.getTextContainer());this.contents.setOptions(this.getCustomData("text"));this.getTextContainer().insert(this.contents.draw())}return this},onImageDropped:function(b,a){info("content -> image dropped");var c=this.image.isEmpty();this.image.removeDroppable();this.image=new Wysija.Image(this.getImageContainer());this.image.setOptions(a);this.getImageContainer().writeAttribute("style","");this.getImageContainer().update(this.image.draw());this.setup("image");Wysija.get(this.element).block.image=this.image;if(c){this.image.setBlockAlignment(Wysija.defaults.contentAlignment);this.contents.alignment=this.image.alignment}this.contents.constrainSize();Wysija.autoSave()},onTextDropped:function(b,a){info("content -> text dropped");this.contents.removeDroppable();this.contents=new Wysija.Text(this.getTextContainer());this.contents.setOptions(a);this.getTextContainer().update(this.contents.draw());this.setup("text");this.contents.setFocus();Wysija.get(this.element).block.contents=this.contents;Wysija.hideControls();Wysija.hideTools();Wysija.autoSave()},drawContainer:function(b){var a="";if(b=="image"){a='style="width:300px;"'}return'<div class="wysija_'+b+'"'+a+"></div>"},getImageContainer:function(){return this.element.down(".wysija_image")},getTextContainer:function(){return this.element.down(".wysija_text")},getContainer:function(){return this.element.down(".wysija_content")},minWidth:function(){return this.constraints[this.alignment].minWidth},maxWidth:function(){return this.constraints[this.alignment].maxWidth},fullWidth:function(){return this.constraints.full.maxWidth},setup:function(a){if(a=="text"){info("content -> setup text");if(this.contents!=null){this.contents.setup()}}else{if(a=="image"){info("content -> setup image");if(this.image!=null){this.image.setup()}}else{if(a==undefined){info("content -> setup undefined");if(this.contents!=null){this.contents.setup()}if(this.image!=null){this.image.setup()}}}}if(this.image.isEmpty()&&this.contents.isEmpty()==false){this.setBlockAlignment("center")}},getControls:function(){return this.element.down(".wysija_controls")},remove:function(a){if(this.image.isEmpty()&&this.contents.isEmpty()==false){this.setBlockAlignment("center")}if(this.image.isEmpty()&&this.contents.isEmpty()){this.removeBlock()}},setBlockAlignment:function(a){info("content -> set block alignment");this.getContainer().removeClassName("left").removeClassName("center").removeClassName("right");this.getContainer().writeAttribute("wysija_align",a);this.getContainer().addClassName(a);if(this.image!=null){this.image.setAlignment(a);this.image.updateDisplay();if(this.image.tools){this.image.leftButton.stopObserving("click");this.image.centerButton.stopObserving("click");this.image.rightButton.stopObserving("click");this.image.addLinkButton.stopObserving("click");this.image.removeLinkButton.stopObserving("click");this.image.removeButton.stopObserving("click")}this.image.setup()}if(this.contents!=null){this.contents.getTextContainer().stopObserving("click",this.enableEditor);this.contents.setAlignment(a);if(this.contents.tools){this.contents.removeButton.stopObserving("click")}this.contents.setup()}Wysija.autoSave();return this},getBlock:function(){return this.element.up(".wysija_block")}});Object.extend(Wysija.Content,Observable).observe(".wysija_block");Wysija.FullContent=Class.create(Wysija.Block,{contents:null,image:null,constraints:{left:{minWidth:32,maxWidth:325},right:{minWidth:32,maxWidth:325},center:{minWidth:32,maxWidth:600},full:{maxWidth:600}},initialize:function(a,b){info("full content -> init");this.element=$(a);if(this.getTextContainer()){this.contents=new Wysija.FullText(this.getTextContainer())}if(this.getImageContainer()){this.image=new Wysija.FullImage(this.getImageContainer())}return this},save:function(){var a={};if(this.contents!=null){a.text=this.contents.save()}if(this.image!=null){a.image=this.image.save();if(this.image.isEmpty()==false){a.alignment=a.image["alignment"]}else{a.alignment="center"}a["static"]=(this.element.hasClassName("static"))}return a},draw:function(){if(this.image==null){this.element.childElements().last().insert(this.drawContainer("image"));this.image=new Wysija.FullImage(this.getImageContainer());this.image.setOptions(this.getCustomData("image"));this.getImageContainer().insert(this.image.draw())}if(this.contents==null){this.element.childElements().last().insert(this.drawContainer("text"));this.contents=new Wysija.FullText(this.getTextContainer());this.contents.setOptions(this.getCustomData("text"));this.getTextContainer().insert(this.contents.draw())}return this},onImageDropped:function(b,a){info("content -> image dropped");var c=this.image.isEmpty();this.image.removeDroppable();this.image=new Wysija.FullImage(this.getImageContainer());this.image.setOptions(a);this.getImageContainer().writeAttribute("style","");this.getImageContainer().update(this.image.draw());this.setup("image");Wysija.get(this.element).block.image=this.image;if(c){this.image.setBlockAlignment(Wysija.defaults.contentAlignment);this.contents.alignment=this.image.alignment}this.contents.constrainSize();Wysija.autoSave()},onTextDropped:function(b,a){info("content -> text dropped");this.contents.removeDroppable();this.contents=new Wysija.FullText(this.getTextContainer());this.contents.setOptions(a);this.getTextContainer().update(this.contents.draw());this.setup("text");this.contents.setFocus();Wysija.get(this.element).block.contents=this.contents;Wysija.hideControls();Wysija.hideTools();Wysija.autoSave()},drawContainer:function(b){var a="";if(b=="image"){a='style="width:300px;"'}return'<div class="wysija_'+b+'"'+a+"></div>"},getImageContainer:function(){return this.element.down(".wysija_image")},getTextContainer:function(){return this.element.down(".wysija_text")},getContainer:function(){return this.element.down(".wysija_content")},minWidth:function(){return this.constraints[this.alignment].minWidth},maxWidth:function(){return this.constraints[this.alignment].maxWidth},fullWidth:function(){return this.constraints.full.maxWidth},setup:function(a){if(a=="text"){info("content -> setup text");if(this.contents!=null){this.contents.setup()}}else{if(a=="image"){info("content -> setup image");if(this.image!=null){this.image.setup()}}else{if(a==undefined){info("content -> setup undefined");if(this.contents!=null){this.contents.setup()}if(this.image!=null){this.image.setup()}}}}if(this.image.isEmpty()&&this.contents.isEmpty()==false){this.setBlockAlignment("center")}},getControls:function(){return this.element.down(".wysija_controls")},remove:function(a){if(this.image.isEmpty()&&this.contents.isEmpty()==false){this.setBlockAlignment("center")}else{if(this.image.isEmpty()&&this.contents.isEmpty()){$("wysija_header").innerHTML=$("wysija_default_header").innerHTML;Wysija.init()}}},setBlockAlignment:function(a){info("content -> set block alignment");this.getContainer().removeClassName("left").removeClassName("center").removeClassName("right");this.getContainer().writeAttribute("wysija_align",a);this.getContainer().addClassName(a);if(this.image!=null){this.image.setAlignment(a);this.image.updateDisplay();if(this.image.tools){this.image.leftButton.stopObserving("click");this.image.centerButton.stopObserving("click");this.image.rightButton.stopObserving("click");this.image.addLinkButton.stopObserving("click");this.image.removeLinkButton.stopObserving("click");this.image.removeButton.stopObserving("click")}this.image.setup()}if(this.contents!=null){this.contents.getTextContainer().stopObserving("click",this.enableEditor);this.contents.setAlignment(a);if(this.contents.tools){this.contents.removeButton.stopObserving("click")}this.contents.setup()}Wysija.autoSave();return this},getBlock:function(){return this.element.up(".wysija_header")}});Object.extend(Wysija.FullContent,Observable).observe(".wysija_header");var WysijaImageAbstract={initialize:function(a){this.element=$(a);this.alignment=this.getDefaultAlignment();this.params=new Hash();return this},save:function(){if(this.isEmpty()){return null}return{src:this.getImageElement().readAttribute("src"),width:parseInt(this.getImageElement().readAttribute("width")),height:parseInt(this.getImageElement().readAttribute("height")),url:this.params.get("url"),alt:this.params.get("alt"),alignment:this.alignment,"static":this.getImageElement().hasClassName("static")}},draw:function(){return this.customDraw()+this.customTools()},customDraw:function(){if(this.getOptions().get("elementSrc")==undefined){this.setOptions({elementSrc:"",elementRatio:1,elementClass:"empty",elementHeight:300,elementWidth:300})}var a=this.getOptions();this.setRatio(a.get("elementRatio")||1);if(a.get("elementClass")==undefined){if(a.get("elementHeight")==undefined){var b=this.maxSize();a.set("elementHeight",b.height);a.set("elementWidth",b.width)}}return'<img class="image_placeholder #{elementClass}" id="" src="#{elementSrc}" height="#{elementHeight}" width="#{elementWidth}" />'.interpolate(a)},customTools:function(){if(this.getOptions().get("elementClass")=="empty"){return""}return'<ul class="wysija_tools"><li><a href="javascript:;" title="'+Wysija_i18n.alignmentLeft+'" class="alignment-left"><span></span></a></li><li><a href="javascript:;" title="'+Wysija_i18n.alignmentCenter+'" class="alignment-center"><span></span></a></li><li><a href="javascript:;" title="'+Wysija_i18n.alignmentRight+'" class="alignment-right"><span></span></a></li><li><a href="javascript:;" title="'+Wysija_i18n.addImageLink+'" class="add-link"><span></span></a></li><li><a href="javascript:;" title="'+Wysija_i18n.removeImageLink+'" class="remove-link"><span></span></a></li><li><a href="javascript:;" title="'+Wysija_i18n.removeImage+'" class="remove"><span></span></a></li></ul>'},setupTools:function(){this.tools=this.getTools();if(this.tools){this.leftButton=this.tools.down(".alignment-left");this.leftButton.observe("click",function(){this.setBlockAlignment("left")}.bind(this));this.centerButton=this.tools.down(".alignment-center");this.centerButton.observe("click",function(){this.setBlockAlignment("center")}.bind(this));this.rightButton=this.tools.down(".alignment-right");this.rightButton.observe("click",function(){this.setBlockAlignment("right")}.bind(this));this.addLinkButton=this.tools.down(".add-link");this.addLinkButton.observe("click",function(){this.addLink()}.bind(this));this.removeLinkButton=this.tools.down(".remove-link");this.removeLinkButton.observe("click",function(){this.removeLink()}.bind(this));this.removeButton=this.tools.down(".remove");this.removeButton.observe("click",function(){this.remove()}.bind(this))}},getTools:function(){return this.element.down(".wysija_tools")},hideTools:function(){this.getTools().hide();this.information.hide()},showTools:function(){this.getTools().show();this.information.show()},addLink:function(){WysijaPopup.open(this.element,Wysija_i18n.addLinkTitle,wysijaAJAX.adminurl+"?page=wysija_campaigns&action=image_data&"+this.params.toQueryString(),this.setData.bind(this),"addlink")},setData:function(a){this.params.set("url",a.url);this.params.set("alt",a.alt);if(this.params.get("url")!=null){this.showLink()}else{this.hideLink()}Wysija.autoSave()},removeLink:function(){this.params.set("url",null);this.hideLink()},showLink:function(){this.addLinkButton.writeAttribute("title",this.params.get("url"));this.addLinkButton.addClassName("active")},hideLink:function(){this.addLinkButton.writeAttribute("title",Wysija_i18n.addImageLink);this.addLinkButton.removeClassName("active")},setBlockAlignment:function(b){info("set block alignment to : "+b);var a=Wysija.get(this.getBlock());a.block.setBlockAlignment(b);this.leftButton.removeClassName("active");this.centerButton.removeClassName("active");this.rightButton.removeClassName("active");this[b+"Button"].addClassName("active");Wysija.autoSave()},remove:function(){info("image -> remove");this.removeDroppable();this.setOptions({elementSrc:undefined});this.element.update(this.draw());this.constrainSize();this.makeDroppable();Wysija.get(this.getBlock()).block.remove("image")},makeDroppable:function(){info("image -> make droppable");Droppables.add(this.getImageElement().identify(),Wysija.imageDropOptions)},removeDroppable:function(){info("image -> remove droppable");Droppables.remove(this.getImageElement().identify())},setup:function(){info("image -> setup");this.createControls();this.setupControls();this.constrainSize();this.setupTools();this.makeDroppable();this.getParameters();if(this[this.alignment+"Button"]){this[this.alignment+"Button"].addClassName("active")}return this},getParameters:function(){info("image -> get parameters");var c=this.element.down(".wysija_params");if(c!=undefined&&this.params.keys().length==0){var a=$F(c.down('input[name="url"]'));if(a!=""){this.params.set("url",a);this.showLink()}var b=$F(c.down('input[name="alt"]'));if(b!=""){this.params.set("alt",b)}}return this},createControls:function(){if(this.getImageElement().hasClassName("empty")||this.getImageElement().hasClassName("static")||this.getResizeControls()!=undefined){return}this.element.insert('<div class="resize-controls"><span class="resize-handle"></span><span class="resize-info"></span></div>')},setupControls:function(){if(this.getImageElement().hasClassName("empty")||this.getImageElement().hasClassName("static")){return}this.ratio=this.getRatio();this.controls=this.getControls();this.handle=this.controls.down(".resize-handle");this.information=this.controls.down(".resize-info");this.handleSize=this.handle.getDimensions();this.draggable=new Draggable(this.handle,{onStart:this.dragStart.bind(this),snap:this.dragSnap.bind(this),change:this.dragChange.bind(this),onEnd:this.dragEnd.bind(this),starteffect:false,endeffect:false});return this},getImageContainer:function(){return this.element},getImageElement:function(){return this.element.down("img")},getResizeControls:function(){return this.element.down(".resize-controls")},minSize:function(){var b=this.minWidth(),a;return{width:b,height:Math.ceil(b/this.ratio)}},maxSize:function(){var b=this.maxWidth(),a;return{width:b,height:Math.ceil(b/this.ratio)}},constrainSize:function(){info("image -> constrainSize : "+this.alignment);this.ratio=this.getRatio();var b=this.minSize(),a=this.maxSize(),c=this.getImageElement();if(c.width>a.width||c.height>a.height){this.getImageContainer().writeAttribute("style","");c.writeAttribute({width:a.width-this.borderWidth(),height:a.height-this.borderWidth()})}else{if(c.width<b.width||c.height<b.height){this.getImageContainer().writeAttribute("style","");c.writeAttribute({width:b.width-this.borderWidth(),height:b.height-this.borderWidth()})}}if(this.alignment=="center"){this.getImageContainer().setStyle({width:c.readAttribute("width")+"px"})}else{this.getImageContainer().setStyle({width:"auto"})}},getRatio:function(){return this.getImageContainer().readAttribute("wysija_ratio")||((this.getImageElement().width/this.getImageElement().height)*1000).round()/1000},setRatio:function(a){this.element.writeAttribute("wysija_ratio",a);return this},isEmpty:function(){return this.getImageElement().hasClassName("empty")},setAlignment:function(a){if(this.isEmpty()){return}this.alignment=a;this.constrainSize();return this},getDefaultAlignment:function(){return this.element.up(".wysija_content").readAttribute("wysija_align")||Wysija.defaults.contentAlignment},dragStart:function(){Wysija.hideEditors();this.dragging=true;Wysija.dragging=true;$$("body")[0].setStyle({cursor:this.handle.getStyle("cursor")});if(this.alignment=="right"){this.element.insert(this.handle)}},dragSnap:function(a,h,g){var c=this.constraints[this.alignment].minWidth,f=this.constraints[this.alignment].maxWidth;if(this.alignment=="right"){var b=this.getImageElement().width,e=b-a;if(e>f){a=b-f;e=f}if(e<c){a=b-c;e=c}h=Math.floor(e/this.ratio-this.handleSize.height)}else{var e=a+this.handleSize.width;if(e>f){a=f-this.handleSize.width;e=f}if(e<c){a=c-this.handleSize.width;e=c}h=Math.floor(e/this.ratio-this.handleSize.height)}return[a,h]},dragChange:function(c,b){if(this.alignment=="right"){var f=this.handle.positionedOffset(),a=this.getImageElement().getDimensions();f.left=a.width-f.left+this.borderWidth();f.top+=this.handleSize.height+this.borderWidth();this.controls.setStyle({left:(a.width-f.left+this.borderWidth())+"px",width:(f.left-(this.borderWidth()*2))+"px",height:(f.top-(this.borderWidth()*2))+"px"})}else{if(this.alignment=="left"){var f=this.handle.positionedOffset();f.left+=this.handleSize.width;f.top+=this.handleSize.height;this.controls.setStyle({width:(f.left-this.borderWidth())+"px",height:(f.top-this.borderWidth())+"px"})}else{if(this.alignment=="center"){var f=this.handle.positionedOffset(),a=this.getImageElement().getDimensions();f.left+=this.handleSize.width;f.top+=this.handleSize.height;this.controls.setStyle({left:(a.width-f.left+this.borderWidth())/2+"px",width:(f.left-this.borderWidth())+"px",height:(f.top-this.borderWidth())+"px"})}}}this.updateDisplay()},dragEnd:function(f,c){this.dragging=false;Wysija.dragging=false;$$("body")[0].setStyle({cursor:""});var b=this.constraints[this.alignment].minWidth,a=this.controls.getWidth();if(a<b){a=b}this.setDimensions(a);this.handle.writeAttribute("style","");if(this.alignment=="right"){this.controls.insert(this.handle);this.controls.writeAttribute("style","");this.element.writeAttribute("style","")}else{if(this.alignment=="center"){this.controls.writeAttribute("style","");this.element.setStyle({width:a+"px"})}else{this.element.writeAttribute("style","")}}Wysija.hideTools();Wysija.constrainSize()},setDimensions:function(b){var b=(b==undefined)?this.maxWidth():b,a=(b/this.ratio).round(),c=this.getImageElement();c.width=b;c.height=a;this.controls.setStyle({width:b+"px",height:a+"px"})},borderWidth:function(){return 1*2},getControls:function(){return this.element.down(".resize-controls")},getInformation:function(){return this.controls.down(".resize-info")},updateDisplay:function(){this.controls=this.getControls();if(this.controls==undefined){return}this.information=this.getInformation();if(this.information==undefined){return}var a=this.controls.getDimensions();this.information.update("#{width} x #{height}".interpolate(a))},setPosition:function(a){this.element.writeAttribute("wysija_position",a)},setLast:function(a){this.element[a?"addClassName":"removeClassName"]("last")}};Wysija.Image=Class.create(Wysija.Content,WysijaImageAbstract);Wysija.FullImage=Class.create(Wysija.FullContent,WysijaImageAbstract);var WysijaTextAbstract={initialize:function(a){this.element=$(a);this.alignment=this.getDefaultAlignment();return this},save:function(){if(this.isEmpty()){return null}return{value:Base64.encode(this.getTextArea().innerHTML)}},draw:function(){info("text -> draw");return this.customDraw()+this.customTools()},customDraw:function(){info("text -> custom draw");if(this.getOptions().get("elementText")==undefined){return'<div class="editable text_placeholder empty" id=""></div>'.interpolate(this.getOptions())}else{return'<div class="editable" id="">#{elementText}</div>'.interpolate(this.getOptions())}},makeDroppable:function(){if(this.isDroppable()){Droppables.add(this.getTextArea().identify(),Wysija.textDropOptions)}},removeDroppable:function(){Droppables.remove(this.getTextArea().identify())},hasContent:function(){return(this.getTextArea()!=undefined)},isDroppable:function(){return this.getTextArea().hasClassName("text_placeholder")},isEmpty:function(){return this.getTextArea().hasClassName("empty")},setup:function(){info("text -> setup");this.setupEditor();this.setAlignment(this.getDefaultAlignment());this.setupTools();this.makeDroppable()},constrainSize:function(b){b|=false;info("text -> constrainSize! : "+this.alignment+" - isEditing: "+(b==true));if(b||tinymce.editors.length>0&&tinymce.editors[0].editorId==this.getTextArea().identify()){this.getTextContainer().setStyle({width:"auto","float":"none"});if(this.getTools()){this.getTools().setStyle({right:0})}switch(this.alignment){case"left":var c=parseInt(this.element.up().down(".wysija_image").down("img").readAttribute("width"));this.getTextContainer().setStyle({width:(this.fullWidth()-c-17)+"px","float":"right"});break;case"right":var c=parseInt(this.element.up().down(".wysija_image").down("img").readAttribute("width"));this.getTextContainer().setStyle({width:(this.fullWidth()-c-17)+"px"});break}this.element.setStyle({height:"auto"})}else{this.getTextContainer().setStyle({width:"auto","float":"none"});if(this.getTools()){this.getTools().setStyle({right:0})}if(this.alignment=="right"){var c=parseInt(this.element.up().down(".wysija_image").down("img").readAttribute("width"));if(this.getTools()){this.getTools().setStyle({right:(c+15+(2*1))+"px"})}}if(this.element.down(".editable").hasClassName("empty")==false){var d=this.element.down(".editable").getHeight();var a=parseInt(this.element.up().down(".wysija_image").down("img").readAttribute("height"));if(this.alignment=="right"||this.alignment=="left"){if(d<a){this.element.setStyle({height:a+"px"})}else{this.element.setStyle({height:"auto"})}}else{if(d<20){this.element.setStyle({height:20+"px"})}else{this.element.setStyle({height:"auto"})}}}}},setAlignment:function(a){info("text -> setAlignment = "+a);this.alignment=a;if(this.isEmpty()==false){this.disableEditor();this.constrainSize()}return this},getDefaultAlignment:function(){return this.element.up(".wysija_content").readAttribute("wysija_align")||Wysija.defaults.contentAlignment},setBlockAlignment:function(b){info("set block alignment to : "+b);var a=Wysija.get(this.getBlock());a.block.setBlockAlignment(b);Wysija.autoSave()},setupEditor:function(){info("text -> setupEditor");if(this.hasContent()){this.getTextContainer().observe("click",this.enableEditor.bind(this))}},customTools:function(){if(this.getOptions().get("elementText")==undefined){return""}return'<ul class="wysija_tools"><li><a href="javascript:;" title="'+Wysija_i18n.removeText+'" class="remove"><span></span></a></li></ul>'},setupTools:function(){this.tools=this.getTools();if(this.tools){this.removeButton=this.tools.down(".remove");this.removeButton.observe("click",function(a){this.remove();a.stop()}.bind(this))}},getTools:function(){return this.element.down(".wysija_tools")},remove:function(){info("text -> remove");this.removeDroppable();this.setOptions({elementText:undefined});this.element.update(this.draw());this.makeDroppable();this.constrainSize(true);Wysija.get(this.getBlock()).block.remove("text")},enableEditor:function(){if(this.element.hasClassName("editing")){return}Wysija.hideEditors();this.constrainSize(true);this.element.addClassName("editing");tinyMCE.execCommand("mceAddControl",false,this.getTextArea().identify())},disableEditor:function(){this.element.removeClassName("editing");tinyMCE.execCommand("mceRemoveControl",false,this.getTextArea().identify())},setFocus:function(){info("text -> setFocus");this.enableEditor()},getTextContainer:function(){return this.element},getTextArea:function(){return this.element.down(".editable")},getTextEditor:function(){return tinymce.get(this.getTextArea().identify())}};Wysija.Text=Class.create(Wysija.Content,WysijaTextAbstract);Wysija.FullText=Class.create(Wysija.FullContent,WysijaTextAbstract);Wysija.Divider=Class.create(Wysija.Block,{initialize:function(a){this.element=$(a);this.setOptions(this.getCustomData("divider"));return this},save:function(){return{divider:{src:this.getDivider().readAttribute("src"),width:parseInt(this.getDivider().readAttribute("width")),height:parseInt(this.getDivider().readAttribute("height"))}}},draw:function(){this.element.childElements().last().insert(this.customDraw())},customDraw:function(){if(!this.getOptions().get("elementSrc")){return'<hr class="divider" />'}else{return'<img class="divider" src="#{elementSrc}" height="#{elementHeight}" width="#{elementWidth}" />'.interpolate(this.getOptions())}},customControls:function(){return""},setup:function(){this.setupControls()},getControls:function(){return this.element.down(".wysija_controls")},setupControls:function(){this.controls=this.getControls();if(this.controls){this.removeButton=this.controls.down(".remove");this.removeButton.observe("click",function(){this.removeBlock();this.removeButton.stopObserving("click")}.bind(this))}return this},getContainer:function(){return this.element.down(".wysija_divider")},getDivider:function(){return this.getContainer().down()}});Wysija.Post=Class.create(Wysija.Block,{called:false,initialize:function(a){info("post -> init");this.element=$(a);return this},draw:function(){WysijaPopup.open(this.element,Wysija_i18n.articleSelectionTitle,wysijaAJAX.adminurl+"?page=wysija_campaigns&action=articles",this.callback.bind(this))},callback:function(a){this.called=true;if(a!=undefined&&a!=""){this.success(Base64.decode(a))}else{this.remove()}Wysija.init()},success:function(a){this.element.replace(a)},setup:function(){},remove:function(){Wysija.instances[this.element.identify()]=null;this.element.remove()}});var WysijaPopup={instance:null,getInstance:function(){return WysijaPopup.instance},open:function(b,c,a,e,d){if(WysijaPopup.instance!=null){WysijaPopup.instance=null}WysijaPopup.instance=new Wysija.Popup(b.identify(),c,a,e,d)},close:function(){tb_remove();WysijaPopup.reset()},reset:function(){WysijaPopup.instance=null}};Wysija.Popup=Class.create({initialize:function(b,c,a,e,d){this.element=$(b);this.title=c;this.url=a;this.callback=e;this.classWindow=d;this.open();return this},open:function(){info("popup -> open");tb_show(this.title,this.url+"&KeepThis=true&TB_iframe=true",null,this.classWindow)},close:function(){if(this.element.hasClassName("wysija_block")){var a=Wysija.get(this.element);if(a.block.called==false){a.block.remove();WysijaPopup.reset()}}return true}});Wysija.DraggableItem=Class.create({initialize:function(a){this.elementType=$(a).readAttribute("wysija_type");this.element=$(a).down()||$(a);this.clone=this.cloneElement();this.insert()},STYLES:new Template("position: absolute; top: #{top}px; left: #{left}px;"),cloneElement:function(){var e=this.element.clone(),d=this.element.cumulativeOffset(),a=document.viewport.getScrollOffsets(),c=this.getList(),b=this.STYLES.evaluate({top:d.top+a.top-c.scrollTop,left:d.left+a.left-c.scrollLeft});e.setStyle(b);e.addClassName("wysija_item_"+this.elementType);if(this.elementType=="image"){e.writeAttribute({elementRatio:this.calculateRatio(),wysija_type:this.elementType})}else{e.innerHTML=this.element.innerHTML}return e},getOffset:function(){return this.element.offsetTop-this.getList().scrollTop},getList:function(){return this.element.up("ul")},insert:function(){$$("body")[0].insert(this.clone)},onMousedown:function(b){var a=new Draggable(this.clone,{scroll:window,onStart:function(){Droppables.displayArea(a)},onEnd:function(c){c.destroy();c.element.remove();Droppables.hideArea()},starteffect:function(c){new Effect.Opacity(c,{duration:0.2,from:c.getOpacity(),to:0.7})},endeffect:Prototype.emptyFunction});a.initDrag(b);a.startDrag(b);return a},calculateRatio:function(){var a=(this.element.readAttribute("wysija_width")/this.element.readAttribute("wysija_height"));return(a*1000).round()/1000}});Object.extend(Wysija.DraggableItem,Observable).observe("a.wysija_item");Wysija.BlockControlBars=Class.create({initialize:function(a){this.element=$(a)},onMouseover:function(a){if(Wysija.dragging==true){return}if(this.element.hasClassName("wysija_block")&&this.element.down(".wysija_controls")&&this.element.down(".wysija_controls").visible()==false){this.element.down(".wysija_controls").show();this.element.addClassName("hover")}},onMouseout:function(a){if(Wysija.dragging==true){return}if(this.element.hasClassName("wysija_block")&&this.element.down(".wysija_controls")&&this.element.down(".wysija_controls").visible()==true){this.element.down(".wysija_controls").hide();this.element.removeClassName("hover")}}});Object.extend(Wysija.BlockControlBars,Observable).observe(".wysija_block");Wysija.ImageControlBars=Class.create({initialize:function(a){this.element=$(a)},onMouseover:function(a){if(Wysija.dragging==true){return}if(this.element.down(".wysija_tools")&&this.element.hasClassName("wysija_image")){this.element.down(".wysija_tools").show();Wysija.hideBlockControls()}if(this.element.down(".resize-controls")&&this.element.down(".resize-controls").visible()==false){this.element.down(".resize-controls").show()}},onMouseout:function(a){if(Wysija.dragging==true){return}if(this.element.hasClassName("wysija_image")){if(this.element.down(".wysija_tools")){this.element.down(".wysija_tools").hide();$$(".wysija_controls").invoke("hide").invoke("removeClassName","hover")}}if(this.element.down(".resize-controls")&&this.element.down(".resize-controls").visible()==true){if(this.element.down(".wysija_tools")){this.element.down(".resize-controls").hide()}}}});Object.extend(Wysija.ImageControlBars,Observable).observe(".wysija_image");Wysija.TextControlBars=Class.create({initialize:function(a){this.element=$(a)},onMouseover:function(a){if(Wysija.dragging==true){return}if(this.element.hasClassName("wysija_text")&&this.element.hasClassName("editing")==false){if(this.element.down(".wysija_tools")){this.element.down(".wysija_tools").show()}}},onMouseout:function(a){if(Wysija.dragging==true){return}if(this.element.hasClassName("wysija_text")){if(this.element.down(".wysija_tools")){this.element.down(".wysija_tools").hide()}}}});Object.extend(Wysija.TextControlBars,Observable).observe(".wysija_text");Wysija.ImagePreview=Class.create({initialize:function(a){this.element=$(a)},onMouseover:function(a){if(Wysija.dragging==true){return}var b=this.element.down("img").clone();if(b.readAttribute("wysija_src")==""){return}b.writeAttribute("src",b.readAttribute("wysija_src"));$("wj_images_preview").insert(b);$("wj_images_preview").show()},onMouseout:function(a){$("wj_images_preview").innerHTML="";$("wj_images_preview").hide()}});Object.extend(Wysija.ImagePreview,Observable).observe(".wj_images li a");Wysija.ThemePreview=Class.create({initialize:function(a){this.element=$(a)},onMouseover:function(a){if(Wysija.dragging==true){return}var b=this.element.down("img").clone();if(b.readAttribute("wysija_src")==""){return}b.writeAttribute("src",b.readAttribute("wysija_src"));$("wj_themes_preview").insert(b);$("wj_themes_preview").show()},onMouseout:function(a){$("wj_themes_preview").innerHTML="";$("wj_themes_preview").hide()}});Object.extend(Wysija.ThemePreview,Observable).observe(".wj_themes li a");Wysija.ToolbarTabs=Class.create({initialize:function(a){this.element=$(a)},onClick:function(a){if(Wysija.dragging==true){return}$$("#"+Wysija.options.toolbar+" .tabs a").invoke("removeClassName","selected");$$(".wj_images, .wj_content, .wj_styles, .wj_themes").invoke("hide");$$(".wj_"+a.target.rel)[0].show();$(a.target).addClassName("selected")}});Object.extend(Wysija.ToolbarTabs,Observable).observe("#"+Wysija.options.toolbar+" .tabs a");Wysija.TextLinks=Class.create({initialize:function(a){this.element=$(a)},onClick:function(a){a.stop();return false}});Object.extend(Wysija.TextLinks,Observable).observe(".editable a");window.document.observe("mousedown",function(a){if(tinymce.editors.length>0){if(a.target.id=="mceModalBlocker"){return}if(a.target.hasClassName("mceClose")){return}if(a.target.up(".wysija_text")==undefined){if(a.target.up(".editable")==undefined){if(a.target.hasClassName("mceText")==false){Wysija.hideEditors();Wysija.constrainSize();Wysija.autoSave()}}}}});function debug(a){if(Wysija.options.debug==false){return}try{console.log("[DEBUG] "+a)}catch(b){}}function info(a){if(Wysija.options.debug==false){return}try{console.log("[INFO] "+a)}catch(b){}};