var colorPicker=Class.create({initialize:function(){var a=$A(arguments);this.el=$(a[0]);this.options=Object.extend({previewElement:false,inputElement:false,eventName:"click",onLoad:function(){return true},onShow:function(){return true},onBeforeShow:function(){return true},onHide:function(){return true},onChange:function(){return true},onSubmit:function(){return true},color:"000000",origColor:false,livePreview:true,hideOnSubmit:true,updateOnChange:true,flat:false,hasExtraInfo:false,extraInfo:function(){return true}},a[1]);this.ids={};this.fields=[];this.current={};this.inAction=false;this.charMin=65;this.visible=false;this.time=new Date().getTime();this.id="colorpicker_"+this.time;var c='<div class="colorpicker_color"><div><div></div></div></div><div class="colorpicker_hue"><div></div></div><div class="colorpicker_new_color"></div><div class="colorpicker_current_color"></div><div class="colorpicker_hex"><input type="text" maxlength="6" size="6" /></div><div class="colorpicker_rgb_r colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_rgb_g colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_rgb_b colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_hsb_h colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_hsb_s colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_hsb_b colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_submit"></div><div class="colorpicker_extra" style="display:none;"></div><div class="colorpicker_extrafill" style="display:none;"></div>';this.cp=$(document.createElement("DIV"));this.cp.writeAttribute("id",this.id).addClassName("colorpicker").setStyle({display:"none"}).insert(c);if(typeof this.options.color=="string"){this.color=this.HexToHSB(this.options.color)}else{if(this.color.r!=undefined&&this.options.color.g!=undefined&&this.options.color.b!=undefined){this.color=this.RGBToHSB(this.options.color)}else{if(this.options.color.h!=undefined&&this.options.color.s!=undefined&&this.options.color.b!=undefined){this.color=this.fixHSB(this.options.color)}else{return this}}}var b=this;this.options.origColor=this.options.color;if(this.options.flat){this.options.hideOnSubmit=false;this.cp.setStyle({position:"relative",display:"block"});this.el.insert({after:this.cp});this.cp.show()}else{document.body.appendChild(this.cp);$(this.el).observe(this.options.eventName,this.show.bind(this))}this.fields=$$("#"+this.id+" input");this.fields.each(function(d){d.observe("keyup",this.keyUp.bind(this));d.observe("change",function(e){this.change(e.element())}.bind(this));d.observe("blur",this.blur.bind(this));d.observe("focus",this.focus.bind(this))}.bind(this));$$("#"+this.id+" span").each(function(d){d.observe("mousedown",this.downIncrement.bind(this))}.bind(this));this.cp.down("div.colorpicker_current_color").observe("click",this.restoreOriginal.bind(this));this.selector=this.cp.down("div.colorpicker_color");this.selector.observe("mousedown",this.downSelector.bind(this));this.selectorIndic=this.selector.down("div").down("div");this.hue=this.cp.down("div.colorpicker_hue div");this.cp.down("div.colorpicker_hue").observe("mousedown",this.downHue.bind(this));this.newColor=this.cp.down("div.colorpicker_new_color");this.currentColor=this.cp.down("div.colorpicker_current_color");this.submit=this.cp.down("div.colorpicker_submit");this.submit.observe("mouseenter",this.enterSubmit.bind(this));this.submit.observe("mouseleave",this.leaveSubmit.bind(this));this.submit.observe("click",this.clickSubmit.bind(this));this.extra=this.cp.down("div.colorpicker_extra");this.extraInfo=this.cp.down("div.colorpicker_extrafill");if(this.options.hasExtraInfo==true){this.extra.show();this.options.extraInfo(this);this.extra.observe("mouseenter",function(d){d.element().addClassName("colorpicker_focus")});this.extra.observe("mouseleave",function(d){d.element().removeClassName("colorpicker_focus")});this.extra.observe("click",function(e){var d=this.extraInfo;if(d.visible()){d.hide()}else{d.show()}}.bind(this))}this.fillRGBFields(this.color);this.fillHSBFields(this.color);this.fillHexFields(this.color);this.setHue(this.color);this.setSelector(this.color);this.setCurrentColor((this.options.origColor?this.options.origColor:this.color));this.setNewColor(this.color);if($(this.options.previewElement)){$(this.options.previewElement).setStyle({backgroundColor:"#"+this.HSBToHex(this.color)})}this.options.onLoad(this);return this},fillRGBFields:function(a){var b=this.HSBToRGB(a);this.fields[1].value=b.r;this.fields[2].value=b.g;this.fields[3].value=b.b},fillHSBFields:function(a){this.fields[4].value=parseInt(a.h);this.fields[5].value=parseInt(a.s);this.fields[6].value=parseInt(a.b)},fillHexFields:function(a){this.fields[0].value=this.HSBToHex(a).toUpperCase()},setSelector:function(a){this.selector.setStyle({backgroundColor:"#"+this.HSBToHex({h:a.h,s:100,b:100})});this.selectorIndic.setStyle({left:parseInt(150*a.s/100,10)+"px",top:parseInt(150*(100-a.b)/100,10)+"px"})},setHue:function(a){this.hue.setStyle({top:parseInt(150-150*a.h/360,10)+"px"})},setCurrentColor:function(a){this.currentColor.setStyle({backgroundColor:"#"+this.HSBToHex(a)});if(!this.options.origColor){this.options.origColor=a}},setNewColor:function(a){this.newColor.setStyle({backgroundColor:"#"+this.HSBToHex(a)})},keyUp:function(a){var b=a.charCode||a.keyCode||-1;if((b>this.charMin&&b<=90)||b==32){return false}if(this.options.livePreview===true){this.change(a.element())}},change:function(b){var a;if(b.up().className.indexOf("_hex")!=-1){this.color=a=this.HexToHSB(this.fixHex(b.value))}else{if(b.up().className.indexOf("_rgb")!=-1){this.color=a=this.RGBToHSB(this.fixRGB({r:parseInt(this.fields[1].value,10),g:parseInt(this.fields[2].value,10),b:parseInt(this.fields[3].value,10)}))}else{this.color=a=this.fixHSB({h:parseInt(this.fields[4].value,10),s:parseInt(this.fields[5].value,10),b:parseInt(this.fields[6].value,10)})}}this.setSelector(a);this.setHue(a);this.setNewColor(a);this.options.onChange(this);if(this.options.updateOnChange){if(this.el.nodeName=="INPUT"){this.el.value=this.HSBToHex(a)}if($(this.options.inputElement)){$(this.options.inputElement).value=this.HSBToHex(a)}if($(this.options.previewElement)){$(this.options.previewElement).setStyle({backgroundColor:"#"+this.HSBToHex(a)})}}},blur:function(a){a.element().up().removeClassName("colorpicker_focus")},focus:function(a){this.charMin=a.element().hasClassName("_hex")>0?70:65;a.element().addClassName("colorpicker_focus")},downIncrement:function(b){var a=b.element().up();var c=a.down("input");c.focus();this.current={el:a.addClassName("colorpicker_slider"),max:(a.className.indexOf("_hsb_h")!=-1)?360:((a.className.indexOf("_hsb")!=-1)?100:255),y:b.pointerY(),field:c,val:parseInt(c.value,10),preview:this.options.livePreview};this.eventUpIncrement=this.upIncrement.bindAsEventListener(this);document.observe("mouseup",this.eventUpIncrement);this.eventMoveIncrement=this.moveIncrement.bindAsEventListener(this);document.observe("mousemove",this.eventMoveIncrement)},moveIncrement:function(a){this.current.field.value=Math.max(0,Math.min(this.current.max,parseInt(this.current.val+a.pointerY()-this.current.y,10)));if(this.current.preview){this.change(this.current.field)}return false},upIncrement:function(a){this.change(a.element());this.current.el.removeClassName("colorpicker_slider");this.current.el.down("input").focus();if(a.element().up().className.indexOf("_hsb")!=-1){this.fillRGBFields(this.color)}else{this.fillHSBFields(this.color)}this.fillHexFields(this.color);Event.stopObserving(document,"mouseup",this.eventUpIncrement);Event.stopObserving(document,"mousemove",this.eventMoveIncrement);return false},downHue:function(a){this.current={y:a.element().cumulativeOffset().top,preview:this.options.livePreview};this.eventUpHue=this.upHue.bindAsEventListener(this);document.observe("mouseup",this.eventUpHue);this.eventMoveHue=this.moveHue.bindAsEventListener(this);document.observe("mousemove",this.eventMoveHue)},moveHue:function(a){this.fields[4].value=parseInt(360*(150-Math.max(0,Math.min(150,(a.pointerY()-this.current.y))))/150,10);this.change(this.fields[4]);return false},upHue:function(a){this.fillRGBFields(this.color);this.fillHexFields(this.color);this.fields[4].value=parseInt(360*(150-Math.max(0,Math.min(150,(a.pointerY()-this.current.y))))/150,10);this.change(this.fields[4]);Event.stopObserving(document,"mouseup",this.eventUpHue);Event.stopObserving(document,"mousemove",this.eventMoveHue);return false},downSelector:function(a){this.current={pos:a.element().cumulativeOffset(),preview:this.options.livePreview};this.eventUpSelector=this.upSelector.bindAsEventListener(this);document.observe("mouseup",this.eventUpSelector);this.eventMoveSelector=this.moveSelector.bindAsEventListener(this);document.observe("mousemove",this.eventMoveSelector)},moveSelector:function(a){this.fields[6].value=parseInt(100*(150-Math.max(0,Math.min(150,(a.pointerY()-this.current.pos.top))))/150,10);this.fields[5].value=parseInt(100*(Math.max(0,Math.min(150,(a.pointerX()-this.current.pos.left))))/150,10);this.change(a.element());return false},upSelector:function(a){this.moveSelector(a);this.fillRGBFields(this.color);this.fillHexFields(this.color);Event.stopObserving(document,"mouseup",this.eventUpSelector);Event.stopObserving(document,"mousemove",this.eventMoveSelector);return false},enterSubmit:function(a){a.element().addClassName("colorpicker_focus")},leaveSubmit:function(a){a.element().removeClassName("colorpicker_focus")},clickSubmit:function(b){var a=this.color;this.origColor=a;this.setCurrentColor(a);if(this.el.nodeName=="INPUT"){this.el.value=this.HSBToHex(a)}if($(this.options.inputElement)){$(this.options.inputElement).value=this.HSBToHex(a)}if($(this.options.previewElement)){$(this.options.previewElement).setStyle({backgroundColor:"#"+this.HSBToHex(a)})}this.options.onSubmit(this);if(this.options.hideOnSubmit){this.hidePicker()}Event.stopObserving(document,"mousedown",this.eventHide)},show:function(a){this.options.onBeforeShow(this);this.positionPicker(a);if(this.options.onShow(this)){this.cp.setStyle({display:"block"})}this.eventHide=this.hide.bindAsEventListener(this);document.observe("mousedown",this.eventHide);return false},hide:function(b){var a=(typeof(b)=="object")?b.element():$(document.body);if(!this.isChildOf(this.cp,a)){if(this.options.onHide(this)){this.cp.setStyle({display:"none"})}this.clickSubmit();Event.stopObserving(document,"mousedown",this.eventHide)}},isChildOf:function(b,a){if(b==a){return true}return $(a).descendantOf(b)},getViewport:function(){return{l:document.viewport.getScrollOffsets().left,t:document.viewport.getScrollOffsets().top,w:document.viewport.getWidth(),h:document.viewport.getHeight()}},positionPicker:function(a){var e=a.element().cumulativeOffset();var d=this.getViewport();var c=e.top+a.element().getHeight()+d.t;var b=e.left;if(c+176>d.t+d.h){c-=a.element().getHeight()+176}if(b+356>d.l+d.w){b-=(356-this.el.getWidth())}this.cp.setStyle({left:b+"px",top:c+"px"})},fixHSB:function(a){return{h:Math.min(360,Math.max(0,a.h)),s:Math.min(100,Math.max(0,a.s)),b:Math.min(100,Math.max(0,a.b))}},fixRGB:function(a){return{r:Math.min(255,Math.max(0,a.r)),g:Math.min(255,Math.max(0,a.g)),b:Math.min(255,Math.max(0,a.b))}},fixHex:function(c){var a=6-c.length;if(a>0){var d=[];for(var b=0;b<a;b++){d.push("0")}d.push(c);c=d.join("")}return c},HexToRGB:function(a){var a=parseInt(((a.indexOf("#")>-1)?a.substring(1):a),16);return{r:a>>16,g:(a&65280)>>8,b:(a&255)}},HexToHSB:function(a){return this.RGBToHSB(this.HexToRGB(a))},RGBToHSB:function(c){var b={h:0,s:0,b:0};var d=Math.min(c.r,c.g,c.b);var a=Math.max(c.r,c.g,c.b);var e=a-d;b.b=a;if(a!=0){}b.s=a!=0?255*e/a:0;if(b.s!=0){if(c.r==a){b.h=(c.g-c.b)/e}else{if(c.g==a){b.h=2+(c.b-c.r)/e}else{b.h=4+(c.r-c.g)/e}}}else{b.h=-1}b.h*=60;if(b.h<0){b.h+=360}b.s*=100/255;b.b*=100/255;return b},HSBToRGB:function(a){var c={};var g=Math.round(a.h);var f=Math.round(a.s*255/100);var b=Math.round(a.b*255/100);if(f==0){c.r=c.g=c.b=b}else{var i=b;var e=(255-f)*b/255;var d=(i-e)*(g%60)/60;if(g==360){g=0}if(g<60){c.r=i;c.b=e;c.g=e+d}else{if(g<120){c.g=i;c.b=e;c.r=i-d}else{if(g<180){c.g=i;c.r=e;c.b=e+d}else{if(g<240){c.b=i;c.r=e;c.g=i-d}else{if(g<300){c.b=i;c.g=e;c.r=e+d}else{if(g<360){c.r=i;c.g=e;c.b=i-d}else{c.r=0;c.g=0;c.b=0}}}}}}}return{r:Math.round(c.r),g:Math.round(c.g),b:Math.round(c.b)}},RGBToHex:function(a){var b=[a.r.toString(16),a.g.toString(16),a.b.toString(16)];b.each(function(d,c){if(d.length==1){b[c]="0"+d}});return b.join("")},HSBToHex:function(a){return this.RGBToHex(this.HSBToRGB(a))},restoreOriginal:function(){var a=this.options.origColor;this.color=a;this.fillRGBFields(a);this.fillHexFields(a);this.fillHSBFields(a);this.setSelector(a);this.setHue(a);this.setNewColor(a)},showPicker:function(){this.cp.show()},hidePicker:function(){this.cp.hide()},setColor:function(a){if(typeof a=="string"){a=this.HexToHSB(a)}else{if(a.r!=undefined&&a.g!=undefined&&a.b!=undefined){a=this.RGBToHSB(a)}else{if(a.h!=undefined&&a.s!=undefined&&a.b!=undefined){a=fixHSB(a)}else{return this}}}this.color=a;this.origColor=a;this.fillRGBFields(a);this.fillHSBFields(a);this.fillHexFields(a);this.setHue(a);this.setSelector(a);this.setCurrentColor(a);this.setNewColor(a)}});